> æ®è¯´ï¼Œè¿™ä¸ªhookå¯ä»¥æ¨¡æ‹Ÿclassç»„ä»¶çš„ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸ

# å‰è¨€
 å®˜ç½‘å·²ç»ä»‹ç»è¿‡ï¼Œè¿™é‡Œå†å•°å—¦ä¸€æ¬¡ã€‚`useEffect`æ˜¯ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå‰¯ä½œç”¨hookï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œæ¯ä¸€æ¬¡renderä¹‹åæ‰§è¡Œå‰¯ä½œç”¨å’Œæ¸…é™¤ä¸Šä¸€æ¬¡å‰¯ä½œç”¨ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼å°±æ˜¯æ¸…é™¤å‡½æ•°ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¼ å…¥å†…éƒ¨çš„æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°éœ€è¦çš„ä¾èµ–ï¼Œå½“è¿™å‡ ä¸ªä¾èµ–æœ‰ä¸€ä¸ªè¦æ›´æ–°ï¼Œeffecté‡Œé¢ä¹Ÿä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„å‰¯ä½œç”¨å¹¶æ‰§è¡Œå‰¯ä½œç”¨ã€‚å¦‚æœæ²¡æœ‰æ›´æ–°ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ä¼ ï¼Œé‚£ä¹ˆå°±æ˜¯æ²¡æœ‰è¯´æ˜è‡ªå·±æœ‰æ²¡æœ‰ä¾èµ–ï¼Œé‚£å°±æ˜¯æ¯æ¬¡renderè¯¥å‡½æ•°ç»„ä»¶éƒ½æ‰§è¡Œã€‚

å¾ˆæ˜æ˜¾ï¼Œ`useEffect`ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥æ¨¡ä»¿`didmount`ã€`didupdate`ï¼Œå®ƒçš„è¿”å›å€¼å¯ä»¥æ¨¡ä»¿`willunmount`

# classç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ¨¡æ‹Ÿ
> "æ¨¡ä»¿ç”Ÿå‘½å‘¨æœŸï¼ŒuseEffectç¬¬äºŒä¸ªå‚æ•°ä¼ ä¸ªç©ºæ•°ç»„ï¼Œæ— ä¾èµ–ï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œç›¸å½“äºdidmountã€‚å¦‚æœè¦åŒºåˆ†ç”Ÿå‘½å‘¨æœŸï¼Œä¸ä¼ ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ¯æ¬¡éƒ½ä¼šè·‘ï¼Œç›¸å½“äºdidupdateã€‚åŠ ä¸ªmountæ ‡è®°ä¸€ä¸‹ï¼Œé‡Œé¢ç”¨ifåˆ¤æ–­ä¸€ä¸‹ï¼Œå³å¯ä»¥è¾¾åˆ°æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸçš„æ•ˆæœ"

å¾ˆå¤šäººéƒ½ä¼šæƒ³åˆ°è¿™ä¸ªåŠæ³•æ¨¡æ‹Ÿï¼Œäºæ˜¯æˆ‘ä»¬è¯•ä¸€ä¸‹çœ‹çœ‹ï¼š
```jsx
let mount;
function useForceUpdate() {
  const [_, forceUpdate] = useState(0);
  return () => forceUpdate(x => x + 1);
}

function UnmountTest() {
  useEffect(() => {
    if (!mount) {
      mount = true;
      console.log('did mount')
    } else {
      console.log('did update')
    }
    return () => {
      mount = false;
      console.log('unmount') 
    }
  })
  const forceUpdate = useForceUpdate();
  return (<div>
    æˆ‘æ˜¯éšæ—¶è¢«æŠ›å¼ƒçš„
    <button onClick={forceUpdate}>å¼ºåˆ¶æ›´æ–°</button>
  </div>);
}

function State() {
  const [count, setCount] = useState(20);

  const handleCount = useCallback(() => {
    setCount(count => count + 1)
  }, [])
  return (
    <div>
      {count}
      <button onClick={handleCount}>count+1</button>
      {(count % 2) && <UnmountTest />}
    </div>
  )
}
```
å½“countæ˜¯å¥‡æ•°ï¼Œé‚£å°±å±•ç¤º`UnmountTest`ï¼Œç»„ä»¶é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªæ›´æ–°ç»„ä»¶çš„æ–¹æ³•ã€‚æŒ‰ç…§é€»è¾‘ï¼Œ`useEffect`ä¸ä¼ ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¿è¯æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œã€‚ç„¶ååŠ ä¸€ä¸ªæ ‡è®°ï¼Œæ ‡è®°ç¬¬ä¸€æ¬¡æ˜¯æŒ‚è½½ã€‚äºæ˜¯è¿è¡Œä¸€æ³¢çœ‹çœ‹

- ç‚¹ä¸€ä¸‹count+1ï¼Œå±•ç¤ºç»„ä»¶ï¼Œæ‰“å°didmount
- å†ç‚¹ä¸€ä¸‹countï¼Œåˆ æ‰ç»„ä»¶ï¼Œæ‰“å°unmount

ç¬¦åˆé¢„æœŸï¼ŒğŸ˜Š

- ç‚¹ä¸€ä¸‹count+1ï¼Œå±•ç¤ºç»„ä»¶ï¼Œæ‰“å°didmount
- ç‚¹ä¸€ä¸‹å¼ºåˆ¶æ›´æ–°ï¼Œæ‰“å°unmountã€didmountï¼Œå†ç‚¹ï¼Œè¿˜æ˜¯ä¸€æ ·

ğŸ¤”ï¸ï¼Œä»€ä¹ˆé¬¼ï¼Œå±…ç„¶ä¸ç¬¦åˆé¢„æœŸ

> useEffectæ˜¯ç”¨æ¥æ‰§è¡Œå‰¯ä½œç”¨ï¼Œæ¯ä¸€æ¬¡renderï¼Œå°†ä¼šæ¸…é™¤ä¸Šä¸€æ¬¡å‰¯ä½œç”¨ã€æ‰§è¡Œæœ¬æ¬¡å‰¯ä½œç”¨ï¼ˆå¦‚æœæœ‰ä¾èµ–æˆ–è€…ä¸ä¼ å…¥ä¾èµ–æ•°ç»„ï¼‰è¿™ä¸ªhookæ˜¯ä»¥ä¸€ä¸ªå‰¯ä½œç”¨ä¸ºå•ä½ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å¤šæ¬¡ä½¿ç”¨

è¿™æ ·å­è¯´ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯unmountã€didmountï¼Œçš„ç¡®æ˜¯ç¬¦åˆè¿™ä¸ªé€»è¾‘ï¼Œå’Œ"æƒ³å½“ç„¶"çš„é‚£ç§æ¨¡æ‹Ÿç”Ÿå‘½å‘¨æœŸæ˜¯æœ‰ç‚¹ä¸ä¸€æ ·çš„ã€‚è¿™æ ·å­ï¼Œæˆ‘ä»¬æ‹†æˆä¸¤ä¸ªuseEffectè°ƒç”¨ï¼Œå°±å¯ä»¥è§£å†³é—®é¢˜ï¼š
```jsx
function UnmountTest() {
  useEffect(() => {
      if (mount) {
          console.log('did update')
      }
  });
  useEffect(() => {
      if (!mount) {
          console.log('did mount')
          mount = true;
      }
      return () => {
          console.log('unmount')
          mount = false;
      }
  }, []);
  const forceUpdate = useForceUpdate();
  return (<div>
    æˆ‘æ˜¯éšæ—¶è¢«æŠ›å¼ƒçš„
    <button onClick={forceUpdate}>å¼ºåˆ¶æ›´æ–°</button>
  </div>);
}
```

è¿™æ¬¡ï¼Œå…¨éƒ½ç¬¦åˆé¢„æœŸäº†ï¼Œç®€ç›´ojbkğŸ˜Š

# useEffect & useLayoutEffectåŒºåˆ«
> useEffectæ˜¯å¼‚æ­¥çš„ï¼ŒuseLayoutEffectæ˜¯åŒæ­¥çš„

æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œä¸€æ¬¡ç»„ä»¶ä»æŒ‚è½½åˆ°é‡æ–°æ¸²æŸ“ï¼Œä¸¤è€…çš„å‘ç”Ÿçš„æ—¶æœº:

![](https://user-gold-cdn.xitu.io/2019/5/12/16aaca141c8b7546?w=1952&h=468&f=png&s=969064)

ä»å·¦åˆ°å³è¡¨ç¤ºæ—¶é—´çº¿ï¼Œçº¢è‰²çš„æ˜¯å¼‚æ­¥çš„ï¼Œçº¢è‰²æ¡†å†…æ˜¯åŒæ­¥çš„ï¼Œä»ä¸Šåˆ°ä¸‹æ‰§è¡Œã€‚`useEffect`æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€è°“çš„å¼‚æ­¥å°±æ˜¯åˆ©ç”¨`requestIdleCallback`ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ‰§è¡Œä¼ å…¥çš„callbackã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç”¨å“ªä¸€ä¸ªéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœå‰¯ä½œç”¨æ‰§è¡Œæ¯”è¾ƒé•¿ï¼Œæ¯”å¦‚å¤§é‡è®¡ç®—ï¼Œå¦‚æœæ˜¯`useLayoutEffect`å°±ä¼šé€ æˆæ¸²æŸ“é˜»å¡ã€‚è¿™åªæ˜¯ä¸€ä¸ªcaseï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªç¥å¥‡çš„å®šæ—¶å™¨ï¼š


ç‚¹å‡»å¼€å§‹ï¼Œå¼€å§‹è®¡æ—¶ï¼Œç‚¹å‡»æš‚åœå°±æš‚åœã€‚ç‚¹å‡»æ¸…0ï¼Œæš‚åœå¹¶ä¸”æ•°å­—æ¸…é›¶
```jsx
function LYE() {
  const [lapse, setLapse] = React.useState(0)
  const [running, setRunning] = React.useState(false)

  useEffect(
    () => {
      if (running) {
        const startTime = Date.now() - lapse
        const intervalId = setInterval(() => {
          setLapse(Date.now() - startTime)
        }, 2)
        console.log(intervalId)
        return () => clearInterval(intervalId)
      }
    },
    [running],
  )

  function handleRunClick() {
    setRunning(r => !r)
  }

  function handleClearClick() {
    setRunning(false)
    setLapse(0)
  }

  return (
    <div>
      <label>{lapse}ms</label>
      <button onClick={handleRunClick}>
        {running ? 'æš‚åœ' : 'å¼€å§‹'}
      </button>
      <button onClick={handleClearClick}>
        æš‚åœå¹¶æ¸…0
      </button>
    </div>
  )
}
```

äºæ˜¯ï¼Œç‚¹å‡»æ¸…é›¶å±…ç„¶ä¸æ¸…0ï¼Œåªæ˜¯åœä¸‹æ¥äº†ï¼Œè€Œä¸”ç‚¹å¼€å§‹ä¹Ÿæ˜¯ç»§ç»­å¼€å§‹ã€‚è¿™é‡Œåªè¦æŠŠå®ƒæ”¹æˆ`useLayoutEffect`å°±å¯ä»¥äº†ï¼Œç‚¹æ¸…0é©¬ä¸Šå˜æˆ0å¹¶åœæ­¢ã€‚å¦å¤–ï¼Œåœ¨ä½¿ç”¨`useEffect`ä¸‹ï¼ŒæŠŠintervalçš„æ—¶é—´æ”¹æˆå¤§äº16ï¼Œæœ‰æ¦‚ç‡æˆåŠŸæ¸…0ï¼Œå¦‚æœæ›´å¤§ä¸€ç‚¹æ˜¯ç»å¯¹æ¸…é›¶ã€‚éƒ½è¯´`useEffect`æ˜¯å¼‚æ­¥ï¼Œé‚£ä¹ˆé—®é¢˜å¾ˆæœ‰å¯èƒ½å‡ºç°åœ¨å¼‚æ­¥è¿™é‡Œã€‚

`useLayoutEffect`æ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥æ•´ä¸ªæµç¨‹å®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œä¸€åˆ‡åœ¨æŒæ§ä¹‹ä¸­ã€‚åŸºäºä¸¤ç‚¹ï¼š `useEffect`é‡Œé¢çš„intervalå»¶è¿Ÿå¤ªå°å¹¶æ²¡æœ‰æ¸…é™¤è®¡æ—¶ç»“æœã€`useEffect`æŠŠintervalå»¶è¿Ÿè°ƒåˆ°å¤§äº16åæœ‰æ¦‚ç‡è§£å†³ã€‚æˆ‘ä»¬ä»è¿™ä¸¤ç‚¹å‡ºå‘ï¼Œæ¢³ç†ä¸€ä¸‹`useEffect`æ‰§è¡Œæ—¶æœºï¼š

![](https://user-gold-cdn.xitu.io/2019/5/12/16aacba0a3cd5d3d?w=970&h=189&f=png&s=72725)

è¿™ç§æƒ…å†µæ˜¯æ²¡æœ‰æ¸…é™¤å®šæ—¶å™¨ç»“æœçš„ï¼Œæ³¨æ„ä¸­é—´é‚£å—ï¼šinterval1 =ã€‹ render =ã€‹ clean useEffect1ã€‚ clean useEffect1ä¹‹å‰åˆè·‘äº†ä¸€æ¬¡interval1ï¼Œinterval1è§¦å‘renderï¼Œå±•ç¤ºçš„æ˜¯å½“å‰è®¡æ—¶ç»“æœã€‚å‰é¢çš„stopæ“ä½œï¼Œ    `setRunning(false)`å’Œ`setLapse(0)`çš„ç¡®æ˜¯è·‘äº†ï¼Œä½†æ˜¯interval1åˆè®¾ç½®äº†å½“å‰è®¡æ—¶ç»“æœï¼Œæ‰€ä»¥`setLapse(0)`å°±æ˜¯ç™½æäº†ã€‚

> æŠŠintervalå»¶è¿Ÿè°ƒå¤§

![](https://user-gold-cdn.xitu.io/2019/5/12/16aacbe084570c6a?w=946&h=227&f=png&s=60300)

è¿™ç§æƒ…å†µæ˜¯æ­£å¸¸çš„ï¼Œæ˜¾ç„¶å…¨éƒ¨éƒ½åœ¨æˆ‘ä»¬é¢„æœŸä¹‹å†…ã€‚ç»è¿‡å¤šæ¬¡æµ‹è¯•ï¼Œå»¶è¿Ÿä¸´ç•Œç‚¹æ˜¯16msã€‚

> ä¸ºä»€ä¹ˆå°±æ˜¯16msï¼Ÿ

æœ‰é—®é¢˜ï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°å¼‚æ­¥ï¼Œè¯´åˆ°å¼‚æ­¥åˆæƒ³åˆ°äº†`requestIdleCallback`ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æµè§ˆå™¨ç©ºé—²çš„æ—¶å€™æ‰§è¡Œcallbackã€‚ç±»ä¼¼äº`requestAnimationFrame`ï¼Œåªæ˜¯`requestIdleCallback`æŠŠä¼˜å…ˆçº§æ”¾ä½äº†ã€‚è¯´åˆ°`requestAnimationFrame`å°±æƒ³åˆ°äº†å¹³å‡60fpsï¼Œæ¥ç€1000/60 å°±æ˜¯16.66666ï¼Œæ‰€ä»¥æ¯ä¸€å¸§çš„é—´éš”å¤§çº¦æ˜¯16mså·¦å³ã€‚æœ€åï¼Œé—®é¢˜æ¥æºå°±è¿™æ ·æš´éœ²å‡ºæ¥äº†ï¼Œå½“intervalé—´éš”å¤§äºå±å¹•ä¸€å¸§æ—¶é—´ï¼Œç”¨`useEffect`æ­¤å®šæ—¶å™¨ä¸ä¼šæœ‰é—®é¢˜ï¼Œåä¹‹åˆ™æ˜¯intervalä¼šåœ¨useEffectä¹‹å‰å¤šæ‰§è¡Œä¸€æ¬¡é€ æˆé—®é¢˜çš„å‡ºç°ã€‚

> å¦‚æœæ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œ[github](https://github.com/lhyt/issue/issues/37) , [æ˜é‡‘](https://juejin.im/user/5acc4ab4f265da239148703d)  å¯ä»¥å…³æ³¨ä¸€æ³¢å“¦